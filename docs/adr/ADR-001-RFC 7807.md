# ADR-001: RFC 7807 — Централизованная обработка ошибок и correlation_id

Дата: 2025-11-03
Статус: Accepted

## Context

API в проекте возвращает ошибки в свободном формате. Для удобства клиентов и трассировки инцидентов нужно единообразие ошибок по спецификации RFC 7807 (Problem Details JSON). Также требуется включать `correlation_id` для трассировки через логи и внешние системы, и маскирование деталей внутренних ошибок (stack traces).

## Decision

1. Ввести middleware/exception handler возвращающий ошибки в формате RFC 7807 с полями: `type`, `title`, `status`, `detail`, `instance`.
2. Оборачивать ответ в верхний ключ `error` с `correlation_id` в теле и заголовке `X-Correlation-ID`.
3. Генерировать `correlation_id` (UUIDv4) на входе запроса, пробрасывать в контекст/логгер.
4. Маскировать внутренние детали: 5xx ответы не должны раскрывать стеки, вместо них — общая фраза и `correlation_id`.
5. Валидационные ошибки (422) должны содержать `detail` с map-структурой полей и code `validation_error`.

### Пример JSON (RFC 7807 compatible + correlation)

```json
{
  "type": "https://example.com/problems/validation-error",
  "title": "Validation failed",
  "status": 422,
  "detail": {"title": "must not be empty"},
  "instance": "/posts",
  "correlation_id": "b3f4..."
}
```

## Alternatives

* Оставить текущий формат ошибок — неунифицировано.
* Использовать другой формат (например, internal-only) — уменьшает совместимость.

## Consequences

* Клиенты получают предсказуемые ошибки.
* Улучшенная трассировка инцидентов.

- Потребует изменения обработчиков ошибок и тестов.

## Security impact

Положительный: уменьшение утечки внутренней информации.

## Rollout plan

1. Добавить middleware `core/error_handler.py`.
2. Обновить все raises/HTTPException обработки для использования ProblemDetails schema.
3. Обновить тесты и CI.

## Links

- **NFR:** NFR-04 (валидация данных), NFR-01 (надежность API)
- **Threat Model:** Потоки [F1 /login], [F2 /posts], [F3 /posts] → Риски [R2, R4, R5]
- **Тесты:** `tests/test_secure_coding.py::test_rfc7807_validation_error`
- **RISKS.md:**
  - R2 — Подмена токена / утечка деталей
  - R4 — Неавторизованные изменения
  - R5 — Утечка данных и непредсказуемые ошибки
